<ul class="nav tabs-underlined" id="myTab" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="active tab-underlined" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Home</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="tab-underlined" id="offer-tab" data-toggle="tab" href="#offers" role="tab" aria-controls="offer" aria-selected="false">Offers</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="tab-underlined" id="item-tab" data-toggle="tab" href="#items" role="tab" aria-controls="item" aria-selected="false">Items</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="tab-underlined" id="exchange-tab" data-toggle="tab" href="#exchanges" role="tab" aria-controls="exchange" aria-selected="false">Exchanges</a>
  </li>
</ul>
<% accepted = [] %>
<% @user.items.each do |item| %>
  <% @offerings.each do |offering|%>
    <% accepted << item if offering.offered == item && offering.accepted? %>
  <% end %>
<% end %>
<% accepted_posted = [] %>
<% @user.items.each do |item| %>
  <% @offerings.each do |offering|%>
    <% accepted_posted << item if offering.posted == item && offering.accepted? %>
  <% end %>
<% end %>
<% rejected = [] %>
<% @user.items.each do |item| %>
  <% @offerings.each do |offering|%>
    <% rejected << item if offering.offered == item && offering.rejected? %>
  <% end %>
<% end %>
<% pending = []%>
<% @user.items.each do |item| %>
  <% @offerings.each do |offering|%>
    <% pending << item if offering.offered == item && offering.pending? %>
  <% end %>
<% end %>
<% pending_posted = [] %>
<% @user.items.each do |item| %>
  <% @offerings.each do |offering|%>
    <% pending_posted << item if offering.posted == item && offering.pending? %>
  <% end %>
<% end %>
<% exchanged = []%>
<% @user.items.each do |item| %>
  <% @offerings.each do |offering|%>
    <% if offering.exchanged? %>
      <% exchanged << item if offering.offered == item || offering.posted == item %>
    <% end %>
  <% end %>
<% end %>
<%# From here %>
<div class="tab-content" id="myTabContent">
  <div class="tab-pane fade py-3 show active" id="home" role="tabpanel" aria-labelledby="home-tab">
    <div class= 'info-container' >
      <div class= 'info-card'>
        <p><strong>Name:</strong> <%= @user.name %></p>
        <p><strong>Email:</strong>  <%= @user.email %></p>
        <p><strong>Contact:</strong> <%= @user.phone_number %></p>
        <p><strong>Location:</strong> <%= @user.location %></p>
      </div>
      <div class= 'info-card'>
        <%# No status changed %>
        <p><strong>You have :</strong></p>
        <% if accepted.count != 0 && rejected.count != 0%>
          <p>- <%= accepted.count %> offers accepted</p>
          <p>- <%= rejected.count %> offers rejected</p>
        <% else %>
          <p>No offers have been accepted or rejected.</p>
        <% end %>
        <%# Status changed (status on offerings)%>
        <% if pending.count != 0%>
          <p>- <strong><%= pending.count %></strong> pending offers</p>
        <% else %>
          <p>You have no pending offer!</p>
        <% end %>
      </div>
    </div>
    <div class="status-container">
      <div class="status-card">
        <% if accepted.count != 0 %>
          <p>Most recent upcoming exchange:</p>
          <div class="status-card-container">
            <div class="card-photo"><%= cl_image_tag accepted.first.photo.key, height: 100, width: 100, crop: :fill %></div>
            <div class="card-content">
              <p><%= accepted.first.name %></p>
              <p><%= accepted.first.description %></p>
            </div>
          </div>
        <% else %>
          <p>You have no upcoming exchange!</p>
        <% end %>
      </div>
      <div class="status-card">
        <% pending_items = @user.items.select do |item| %>
          <% @offerings.each do |offering|%>
            <% offering.posted == item && offering.pending? %>
          <% end %>
        <% end %>
        <p>You have <%= pending_items.count %> pending items</p>
      </div>
    </div>
  </div>
  <%# Until here %>
  <div class="tab-pane fade py-3" id="offers" role="tabpanel" aria-labelledby="offer-tab">
    <div class="pending-offer-body">
        <% if pending.count != 0 %>
          <div class="pending-card-container">
            <div><h4>Your Pending Offers:</h4></div>
            <% pending.each do |user_item| %>
              <div class="pending-offer-card">
                <div class="posted-item-card">
                  <% pending_posted_item = @offerings.map do |offering| %>
                    <% offering.posted if user_item == offering.offered %>
                  <% end.compact.first%>
                  <div class="card-photo"><p>Item interested:</p>
                    <% if pending_posted_item.photo.attached? %>
                      <%= link_to item_path(pending_posted_item) do%>
                        <%= cl_image_tag(pending_posted_item.photo.key)%>
                      <% end %>
                    <% end %>
                  </div>
                  <div class="card-content">
                    <p><%= link_to pending_posted_item.name.capitalize, item_path(pending_posted_item)%></p>
                    <div class="text"><p>Owner: <%= pending_posted_item.user.name %></p></div>
                  </div>
                </div>
                <div class='arrow'><i class="fas fa-arrow-left"></i></div>
                <div class="offered-item-card">
                  <div class="card-photo">
                    <p>Your offer:</p>
                    <% if user_item.photo.attached? %>
                      <%= link_to item_path(user_item) do%>
                        <%= cl_image_tag(user_item.photo.key)%>
                      <% end %>
                    <% end %>
                  </div>
                  <div class="card-content">
                    <p><%= link_to user_item.name.capitalize, item_path(user_item)%></p>
                    <p class='booking-tag'>pending</p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p>You have no pending offer!</p>
        <% end %>
    </div>
  </div>
  <div class="tab-pane fade py-3" id="items" role="tabpanel" aria-labelledby="item-tab">
    <div class="item-card-body" style='background-color: white'>
      <div class="user-items-card-container">
        <% @user.items.each do |item| %>
          <div class="item-card">
            <div class="imgBx">
              <%= link_to item_path(item) do%>
                <%= cl_image_tag(item.photo.key) %>
              <% end %>
            </div>
            <div class="item-content">
              <div class="productName">
                <%= link_to item.name.capitalize, item_path(item)%>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <div class="tab-pane fade py-3" id="exchanges" role="tabpanel" aria-labelledby="exchange-tab">
    <div class="pending-offer-body">
        <% if accepted.count != 0 || accepted_posted.count != 0%>
          <% accepted_items = accepted + accepted_posted %>
          <div class="pending-card-container">
            <h4>Your upcoming exchanges:</h4>
          <%# !ADD SORT BY DATE  %>
            <% accepted_items.each do |user_item| %>
              <div class="pending-offer-card">
                <div class="offered-item-card">
                  <div class="card-photo"><p>Your offer:</p><%= cl_image_tag(user_item.photo.key) %></div>
                  <div class="card-content">
                    <p><%= user_item.name.capitalize %></p>
                  </div>
                </div>
                <div class="arrow">
                  <% offering = Offering.find_by(posted: user_item) ?  Offering.find_by(posted: user_item) : Offering.find_by(offered: user_item) %>
                  <div data-controller='alarm'>
                    <div class="form" data-alarm-target= 'form' data-action='click->alarm#confirm'>
                      <%= form_for offering do |t| %>
                        <%= t.hidden_field :status, value: 'exchanged' %>
                        <%= t.submit "Exchanged?", class: ' btn btn-primary' %>
                      <% end %>
                    </div>
                  </div>
                  <%# <i class="fas fa-arrows-alt-h"></i> %>
                </div>
                <div class="posted-item-card">
                  <% accepted_corresponding_item = @offerings.map do |offering| %>
                    <% user_item == offering.offered ? offering.posted : offering.offered%>
                  <% end.compact.first%>
                  <div class="card-photo"><p><%=accepted_corresponding_item.user.name%>'s offer:</p><%= cl_image_tag(accepted_corresponding_item.photo.key) %></div>
                  <div class="card-content">
                    <p><%= accepted_corresponding_item.name.capitalize %></p>
                    <div class="text"><p>Owner: <%= accepted_corresponding_item.user.name %></p></div>
                    <div class="text"><p>Phone Number: <%= accepted_corresponding_item.user.phone_number %></p></div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p>You have no upcoming exchange!</p>
        <% end %>
    </div>
    <div class="pending-offer-body">
        <% if exchanged.count != 0%>
          <div class="pending-card-container">
            <h4>Past exchanges:</h4>
          <%# !ADD SORT BY DATE  %>
            <% exchanged.each do |user_item| %>
              <div class="pending-offer-card">
                <%# Time and Location  %>
                <div class="offered-item-card">
                  <div class="card-photo"><%= cl_image_tag(user_item.photo.key)%></div>
                  <div class="card-content">
                    <p><%= user_item.name.capitalize %></p>
                  </div>
                </div>
                <div class="arrow"><i class="fas fa-arrows-alt-h"></i></div>
                <div class="posted-item-card">
                  <% accepted_corresponding_item = @offerings.map do |offering| %>
                    <% user_item == offering.offered ? offering.posted : offering.offered%>
                  <% end.compact.first%>
                  <div class="card-photo">
                    <%= cl_image_tag(accepted_corresponding_item.photo.key) %>
                  </div>
                  <div class="card-content">
                    <p><%= accepted_corresponding_item.name.capitalize %></p>
                    <div class="text"><p>Owner: <%= accepted_corresponding_item.user.name %></p></div>
                    <div class="text"><p>Phone Number: <%= accepted_corresponding_item.user.phone_number %></p></div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p>Past exchanges:</p>
          <p>No exchanges have been made so far!</p>
        <% end %>
    </div>
  </div>
</div>
